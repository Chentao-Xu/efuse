# λ-IO笔记   
# 论文概述   
λ-IO是一套跨主机和设备，管理计算和存储资源的统一IO堆栈   
IO堆栈是计算机操作系统中处理输入输出请求的分层架构，主要作用是实现数据从应用程序到硬件设备（例如磁盘、网络适配器）的传输，同时提供抽象和优化，使得不同的应用程序能够在不直接操作硬件的情况下进行 I/O 访问   
## 核心贡献   
- 统一接口：让应用程序可以透明地在主机和存储设备上执行计算任务   
- sBPF：storage BPF 运行时，对eBPF进行扩展，支持存储计算   
- 动态请求调度：智能分配计算任务到性能更优地一侧（主机或设备）   
   
# 背景和动机   
## 计算存储（In-Storage Computing, ISC）   
- 传统数据密集型应用如数据库，需要从存储设备加载大量数据到主机内存进行计算，数据移动开销大   
- 计算存储设备在存储设备中集成计算能力，减少数据移动，提高性能   
   
## IO堆栈   
局限性   
- 传统IO堆栈主要用于数据存储和传输，缺乏计算运行时   
- 现有计算存储方案主要关注设备端计算，未能充分利用主机计算能力   
   
相比于用户空间IO库的优势   
- 兼容性，大量应用程序依赖于POSIX文件接口来存储数据   
- 功能性，IO堆栈提供了丰富的模块和功能，包括文件系统和页面缓存，用户空间IO库只支持与原始存储设备的数据传输   
- 共享性，有资源分配和安全机制，用户和应用程序可以共享整个设备   
   
## 主机与计算设备协调   
主机或计算设备执行程序的速度不同   
- 不同程序功能不同，运算速度不同   
- 相同程序，由于主机缓存的大小不同在同一端的速度也会变化   
   
## eBPF局限性   
- eBPF介绍：略   
- eBPF提供硬件无关的字节码，编译一次可以在CPU和特定硬件上运行   
- eBPF的静态验证器过于严格，缺乏指针访问和动态长度循环的支持，需要扩展以在不影响安全性的前提下支持ISC   
   
# 设计   
## 总体设计   
![image.png"; filename*=UTF-8''image.png](files\image-png-filename-utf-8image.png)    
- λ-IO APIs：在对文件的正常IO外，可以提交请求来定制计算逻辑λ函数，将函数加载到λ-IO，在读写文件时调用这些函数   
- λ运行时：分为内核运行时和设备运行时，提供相同的计算和数据接口，将eBPF扩展为sBPF来支持ISC，编译一次在两端运行   
- 调度器：将λ请求指定给内核运行时或设备运行时，分析监测主机和设备的状态，使用模型估计请求的执行时间并动态调度   
   
## λ-IO 接口 和 工作流   
![image.png"; filename*=UTF-8''image.png](files\image-png-filename-utf-8image_q.png)    
- λ：对计算逻辑进行编程的接口，通过指针访问数据，消耗来自输入缓冲区的数据并产生到输出缓冲区的数据   
- load：加载函数的接口，返回函数的句柄（λ\_id）   
- read：增加了一个λ\_id参数来表示被调用的函数，加载制定范围的文件数据作为输入执行函数计算，将输出复制到buf   
- write相似   
   
## 跨平台 λ 运行时   
扩展 eBPF 到 sBPF   
继承格式但是扩展了验证器和JIT   
- 指针访问：动态检查指针是否落在指定区域内   
- 动态长度循环：设置阈值，限制回跳次数   
- 安全性：相比eBPF不会引入额外的安全风险   
   
文件访问一致性   
- 内核运行时：置于VFS和页面缓存之上，使用统一的文件抽象和访问接口，提出内核版mmap，将请求范围内的页面映射到虚拟内存避免大量拷贝   
- 设备运行时：设备必须先知道文件中范围的确切存储位置，λ-IO将文件指定范围的元数据下推到设备，设备取出后放到设备内存，并将地址传递给设备中运行的λ函数   
- 一致性：数据可能在主机用户空间、主机内核和设备中被修改，需要保证一致性   
    - 用户空间和内核一致，依赖VFS和页面缓存   
    - 主机和设备一致性：λ-IO维护，获取文件读写锁，刷新脏缓存等   
   
## 动态请求调度   
对一个请求在主机和设备的执行时间进行建模，预测执行时间更快的一方   
建模执行时间   
- 从存储介质加载的数据大小D   
- 存储介质和设备控制缓冲器之间的带宽Bs   
- 设备和主机之间的带宽Bd   
- 主机侧的计算带宽Bh   
- 设备侧的计算带宽βBh   
- 如果计算在设备侧，主机和设备之间传输数据的大小为αD   
   
读取时间公式   
![image.png"; filename*=UTF-8''image.png](files\image-png-filename-utf-8image_4.png)    
有缓存的读取时间   
![image.png"; filename*=UTF-8''image.png](files\image-png-filename-utf-8image_w.png)    
写入时间公式   
![image.png"; filename*=UTF-8''image.png](files\image-png-filename-utf-8image_o.png)    
   
定期分析和调度   
将上述变量分为两组   
- 直接获取精确值：数据大小D，主机端缓存率c   
- 分析估计：其余五个变量通过定期分析来估计，设置一个分析周期，内核运行时和设备运行时在执行期间测量请求的分析变量的值，k个请求完成后计算平均值，同一时间段的请求使用估计的变量值对执行时间进行建模   
   
# 实现   
略   
# 评估   
略   
